"use client"

import { useWeb3Modal } from "@web3modal/wagmi/react"
import { Copy, ExternalLink, LogOut, Network, Wallet } from "lucide-react"
import Link from "next/link"
import { useAccount, useDisconnect, useNetwork } from "wagmi"

import { Button } from "@/components/ui/button"
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import { getWalletIcon, shortenAddress } from "@/utils/wallet"
import { ClientOnly } from "./client-only"
import { ImageWithHideOnError } from "./ui/image-with-hide-on-error"

export function Navbar() {
  return (
    <nav className="flex w-full justify-between items-center min-h-[40px] border-b p-4">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 462 79"
        height={30}
      >
        <g clipPath="url(#a)">
          <path
            fill="#00DF81"
            d="M77.317 40.662c-4.71 0-9.012 1.829-12.463 4.883a30.88 30.88 0 00-9.107-4.62 16.367 16.367 0 004.71-5.1c4.901-.093 9.55-1.767 13.063-5.224 4.302-4.232 5.909-10.154 5.153-16.169a23.06 23.06 0 00-2.931-.17c-5.074 0-9.88 1.674-13.504 5.24-3.624 3.565-5.325 8.309-5.325 13.3a11.89 11.89 0 01-8.336 6.403V28.028c3.53-3.52 5.689-8.03 5.689-13.007 0-5.983-3.105-11.3-7.973-15.021-4.87 3.705-7.973 9.022-7.973 15.021 0 4.977 2.158 9.503 5.672 13.007v11.239c-3.718-.667-6.917-3.008-8.619-6.403 0-5.007-1.686-9.781-5.325-13.347-3.624-3.565-8.43-5.24-13.504-5.24-.961 0-1.938.047-2.93.17-.773 6.016.834 11.937 5.152 16.17 3.498 3.44 8.13 5.115 13.03 5.224a16.175 16.175 0 004.806 5.162 30.814 30.814 0 00-8.886 4.542c-3.451-3.038-7.753-4.883-12.464-4.883-6.082 0-11.487 3.054-15.268 7.844 3.766 4.79 9.17 7.844 15.268 7.844 4.632 0 8.871-1.767 12.29-4.728.126-.109.252-.233.378-.341.19-.17.363-.341.536-.512 4.317-3.875 9.722-6.185 15.52-6.666v10.139c-12.684 1.116-22.72 11.44-23.304 24.167h4.585c.473-10.309 8.51-18.525 18.735-19.625V78.3h4.585V58.784c10.21 1.07 18.278 9.3 18.782 19.625h4.585c-.614-12.743-10.683-23.082-23.367-24.168V44.12a26.43 26.43 0 0115.536 6.681c.174.155.331.326.505.48.126.125.267.249.394.373 3.419 2.945 7.657 4.728 12.29 4.728 6.082 0 11.486-3.054 15.268-7.844-3.766-4.79-9.17-7.844-15.268-7.844l.015-.031zM65.468 22.71c2.758-2.712 6.035-3.611 8.745-3.86-.299 3.38-1.623 6.34-3.923 8.573-2.757 2.713-6.035 3.612-8.745 3.86.3-3.38 1.623-6.34 3.923-8.573zM42.89 15.021c0-3.162 1.198-6.216 3.388-8.805 2.221 2.605 3.387 5.612 3.387 8.805 0 3.194-1.197 6.217-3.387 8.806-2.222-2.605-3.388-5.643-3.388-8.806zM21.996 27.423c-2.3-2.263-3.624-5.209-3.923-8.573 2.678.233 5.987 1.148 8.744 3.86 2.27 2.264 3.625 5.21 3.924 8.573-2.679-.233-5.988-1.147-8.745-3.86zm-6.76 24.416c-3.23 0-6.318-1.178-8.95-3.333 2.648-2.186 5.736-3.333 8.95-3.333 3.215 0 6.319 1.178 8.95 3.333-2.647 2.186-5.704 3.333-8.95 3.333zm62.066 0c-3.23 0-6.319-1.178-8.95-3.333 2.647-2.186 5.735-3.333 8.95-3.333 3.214 0 6.318 1.178 8.95 3.333-2.648 2.186-5.704 3.333-8.95 3.333z"
          ></path>
          <path
            className="lg:block hidden"
            fill="#F1F7F6"
            d="M156.984 19.486c4.553 0 8.209 1.457 10.982 4.356 2.82 2.822 4.223 6.713 4.223 11.704v22.292h-7.753V36.786c0-3.24-.772-5.735-2.316-7.518-1.544-1.783-3.655-2.666-6.334-2.666-2.82 0-5.105.945-6.87 2.836-1.765 1.892-2.647 4.403-2.647 7.55v20.835h-7.736V36.91c0-3.193-.788-5.704-2.364-7.55-1.576-1.844-3.703-2.758-6.366-2.758-2.82 0-5.121.96-6.901 2.867-1.781 1.907-2.679 4.465-2.679 7.643v20.71h-7.736V20.54h7.595v5.395c1.134-1.984 2.694-3.55 4.711-4.713 2.017-1.162 4.27-1.736 6.759-1.736 2.584.047 4.932.667 7.044 1.876 2.111 1.194 3.671 2.868 4.648 4.976 1.308-2.077 3.198-3.736 5.656-4.976 2.474-1.256 5.153-1.876 8.068-1.876h.016zm52.579 6.247V20.54h7.469v37.313h-7.469v-5.13c-3.419 4.014-7.736 6.03-12.952 6.03-5.499 0-10.021-1.892-13.582-5.674-3.561-3.783-5.357-8.495-5.357-14.123 0-5.627 1.78-10.2 5.357-13.843 3.561-3.643 8.083-5.456 13.582-5.456 5.499 0 9.533 2.03 12.952 6.092v-.016zm-11.896 26.028c3.514 0 6.444-1.225 8.792-3.674 2.301-2.403 3.451-5.379 3.451-8.929 0-3.55-1.15-6.464-3.451-8.867-2.348-2.434-5.278-3.659-8.792-3.659-3.514 0-6.555 1.225-8.792 3.659-2.253 2.403-3.388 5.38-3.388 8.929 0 3.55 1.135 6.542 3.388 8.93 2.253 2.402 5.184 3.611 8.792 3.611zm35.327 6.092h-7.737V20.54h7.595v5.255c1.134-1.938 2.742-3.457 4.853-4.573 2.111-1.116 4.506-1.659 7.169-1.659 4.176 0 7.705 1.334 10.557 4.015 2.915 2.729 4.365 6.573 4.365 11.565v22.71h-7.815v-20.57c0-3.38-.82-5.985-2.458-7.86-1.639-1.86-3.845-2.806-6.618-2.806-2.915 0-5.279 1.008-7.138 3.007-1.859 2-2.789 4.604-2.789 7.798v20.431h.016zm64.255-32.538V20.54h7.469v33.516c0 5.999-1.875 10.773-5.625 14.323-3.766 3.55-8.73 5.333-14.922 5.333s-11.944-1.783-16.97-5.333l3.372-5.89c4.176 2.96 8.666 4.433 13.44 4.433 3.987 0 7.154-1.1 9.502-3.286 2.347-2.186 3.513-5.038 3.513-8.557V52.38c-3.34 3.69-7.579 5.535-12.747 5.535-5.53 0-10.084-1.814-13.645-5.473-3.561-3.643-5.357-8.216-5.357-13.703 0-5.488 1.859-10.046 5.562-13.642 3.718-3.643 8.304-5.457 13.787-5.457 5.026 0 9.218 1.891 12.605 5.674h.016zM285.29 51.14c3.513 0 6.428-1.178 8.729-3.534 2.3-2.31 3.451-5.24 3.451-8.79 0-3.55-1.151-6.526-3.451-8.79-2.348-2.31-5.247-3.457-8.729-3.457-3.482 0-6.319 1.179-8.666 3.535-2.301 2.263-3.451 5.162-3.451 8.728 0 3.565 1.15 6.557 3.451 8.867 2.347 2.31 5.231 3.457 8.666 3.457v-.016zm35.405 6.713h-7.737V20.54h7.39v5.333c2.253-4.201 5.846-6.31 10.777-6.31 1.592 0 3.104.218 4.507.62l-.693 7.41c-1.261-.465-2.648-.682-4.144-.682-3.057 0-5.5 1.008-7.327 3.039-1.828 2.03-2.742 4.96-2.742 8.805v19.114l-.031-.016zm14.701-18.695c0-5.41 1.875-10.014 5.64-13.843 3.798-3.83 8.604-5.752 14.433-5.752 5.83 0 10.605 1.923 14.355 5.752 3.797 3.782 5.704 8.402 5.704 13.843 0 5.441-1.891 10.2-5.704 13.998-3.719 3.783-8.493 5.674-14.355 5.674-5.861 0-10.62-1.891-14.433-5.674-3.765-3.829-5.64-8.495-5.64-13.998zm32.316 0c0-3.41-1.197-6.34-3.592-8.79-2.301-2.495-5.184-3.736-8.651-3.736-3.466 0-6.334 1.24-8.729 3.736-2.347 2.45-3.513 5.38-3.513 8.79 0 3.41 1.181 6.418 3.513 8.867 2.395 2.45 5.295 3.674 8.729 3.674 3.435 0 6.303-1.224 8.651-3.674 2.395-2.45 3.592-5.41 3.592-8.867zm27.449 8.03l10.84-26.663h8.509l-16.607 37.251h-5.626L375.67 20.525h8.587l10.904 26.663zm57.496-8.728c0 1.194-.094 2.419-.283 3.675h-29.638c.567 2.991 1.906 5.379 4.049 7.13 2.127 1.752 4.979 2.636 8.556 2.636 2.159 0 4.412-.372 6.791-1.1 2.363-.745 4.396-1.706 6.082-2.915l3.23 5.611c-4.743 3.458-10.21 5.194-16.402 5.194-6.666 0-11.723-1.907-15.174-5.752-3.451-3.844-5.168-8.448-5.168-13.843s1.78-10.278 5.341-13.92c3.608-3.69 8.288-5.535 14.008-5.535 5.719 0 9.942 1.69 13.361 5.054 3.42 3.364 5.216 8.014 5.216 13.781l.031-.015zM434.08 26.199c-2.915 0-5.388.9-7.437 2.667-2.048 1.767-3.34 4.123-3.907 7.022h22.09c-.331-2.914-1.481-5.255-3.482-7.022-2.001-1.783-4.412-2.666-7.279-2.666h.015z"
          ></path>
        </g>
        <defs>
          <clipPath id="a">
            <path fill="#fff" d="M0 0h462v78.394H0z"></path>
          </clipPath>
        </defs>
      </svg>
      <ClientOnly>
        <WalletButton />
      </ClientOnly>
    </nav>
  )
}

function WalletButton() {
  const { open } = useWeb3Modal()
  const { isConnected, connector, address, isConnecting } = useAccount()
  const { chain } = useNetwork()
  const { disconnect } = useDisconnect()
  const iconUrl = connector ? getWalletIcon(connector.name) : undefined

  if (!isConnected) {
    return (
      <>
        <Button
          onClick={() => open({ view: "Networks" })}
          disabled={isConnecting}
        >
          Connect to wallet
        </Button>
      </>
    )
  }

  return (
    <div className="inline-flex space-x-2 items-center">
      <w3m-network-button />

      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button className="space-x-2" size={"sm"}>
            <span className="bg-gray-500 h-7 w-7 rounded-md relative overflow-hidden">
              {iconUrl ? (
                <ImageWithHideOnError
                  src={iconUrl}
                  alt={`${connector?.name} logo"`}
                  fill
                  objectFit="contain"
                />
              ) : undefined}
            </span>

            <span>{shortenAddress(address ?? "")}</span>
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent className="w-56 mt-1">
          <DropdownMenuLabel>Wallet: {connector?.name}</DropdownMenuLabel>
          <DropdownMenuItem
            onClick={() => {
              disconnect()
              open({ view: "Connect" })
            }}
          >
            <Wallet className="mr-2 h-4 w-4" />
            <span>Change wallet</span>
          </DropdownMenuItem>
          <DropdownMenuSeparator />
          <DropdownMenuLabel>Chain: {chain?.name}</DropdownMenuLabel>
          <DropdownMenuItem onClick={() => open({ view: "Networks" })}>
            <Network className="mr-2 h-4 w-4" />
            <span>Change network</span>
          </DropdownMenuItem>
          <DropdownMenuSeparator />
          <DropdownMenuGroup>
            <DropdownMenuItem
              onClick={() => {
                address && navigator.clipboard.writeText(address)
              }}
            >
              <Copy className="mr-2 h-4 w-4" />
              <span>Copy address</span>
            </DropdownMenuItem>
            <DropdownMenuItem>
              <Link
                href={`${chain?.blockExplorers?.default.url}/address/${address}`}
                target="_blank"
                className="inline-flex"
              >
                <ExternalLink className="mr-2 h-4 w-4" />
                <span>Open in {chain?.blockExplorers?.default.name}</span>
              </Link>
            </DropdownMenuItem>
          </DropdownMenuGroup>

          <DropdownMenuItem onClick={() => disconnect()}>
            <LogOut className="mr-2 h-4 w-4" />
            <span>Disconnect</span>
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
    </div>
  )
}
